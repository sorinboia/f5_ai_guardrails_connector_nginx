# Test Plan & Coverage Map

Tests now target the Fastify/Node connector (NGINX is retired). This file inventories what we cover, required fixtures, and how to run the suites.

## Test Environment & Prerequisites
- Run unit/helper suites with `cd node && npm test` (Vitest).
- For smokes, use `tests/smoke/node-shadow.sh` which launches backend + Guardrails stubs (ports 18080/18081) and the Node proxy on an alternate port (default 21434). It exercises pass/block/redact/stream flows and reports results.
- HTTPS is optional; self-signed certs live in `certs/sideband-local.crt|key`. Those are now the defaults for `HTTPS_CERT`/`HTTPS_KEY`, so the 22443 listener starts automatically when running from the repo unless you override the env vars.
- Forward proxy: Node listener on port 10000 validates destinations against the config store and relays to local HTTP/HTTPS for inspection. For most local tests you can ignore port 10000 unless explicitly exercising forward-proxy flows.

## Fixtures to Prepare
- `tests/fixtures/requests/` sample bodies: safe chat, PII markers, streaming transcripts, inspection-off payloads, large payload stressor.
- `tests/fixtures/config/`: default host config and host override examples with extractor lists and backend origins.
- `tests/fixtures/api_keys.json`: multiple keys including one with custom `blockingResponse`.
- `tests/fixtures/patterns.json`: request/response/response_stream contexts with matchers (equals/contains/exists) tied to the fixture keys.

## Planned/Existing Suites
- **Config Resolution (`node/src/config/validate.js`)**: defaults, host precedence, header overrides, parallel safety when redaction is on.
- **Config API (`/config/api`)**: GET/POST/PATCH/DELETE/OPTIONS, host uniqueness, enum/url validation, default protection of `__default__`.
- **API Keys (`/config/api/keys`)**: CRUD, name uniqueness, blockingResponse sanitization, timestamp updates.
- **Patterns (`/config/api/patterns`)**: context validation (request/response/response_stream), matcher requirements, API key existence, name uniqueness per context.
- **Collector (`/collector/api`)**: quota clamp at 50, clear/count semantics, entry storage.
- **Proxy & Inspection Pipeline**: sequential vs parallel forwarding, guardrail outcomes (cleared/flagged/redacted), matcher gating, request/response redaction, fail-open fallback, `/api/tags` bypass.
- **Streaming Inspection**: SSE detection, chunk overlap defaults (2048/128), chunk boundary handling, final inspection toggle, passthrough chunk gating/drop flow.
- **Backend Origin Resolution**: host-specific backendOrigin, invalid URL fallback, host list maintenance.
- **Backend Client & Dispatcher**: request header filtering, buffered fetch, passthrough streaming drop on live block, abortable upstream start, CA bundle caching/fallback.
- **Store Persistence & Allowlist**: store shape validation/fallback, host normalization, forward-proxy allowlist helper.
- **Logging & Telemetry**: pattern_result fields, log-level override via `X-Sideband-Log`.

## Execution Helpers
- **Smoke**: `tests/smoke/node-shadow.sh` (uses stub servers, temporary config store). Review logs under `/tmp/node-shadow-*`.
- **Integration (to port)**: Legacy bash cases can be repointed to the Node server by setting `HTTP_PORT` and `CONFIG_STORE_PATH` env vars when starting `node/src/server.js`. Reuse the stub servers in `tests/servers/stub_servers.py`.

## Cleanup Requirements
- Temp config stores created by smokes are auto-removed; if you override `CONFIG_STORE_PATH`, clean it manually between runs.
- Stub servers started by scripts should be terminated at script exit (handled in `node-shadow.sh`).
- Do not truncate logs generated by other processes; keep artefacts per-run under `/tmp` when possible.
