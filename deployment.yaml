apiVersion: apps/v1
kind: Deployment
metadata:
  name: f5-ai-guardrails-connector
  labels:
    app: f5-ai-guardrails-connector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: f5-ai-guardrails-connector
  template:
    metadata:
      labels:
        app: f5-ai-guardrails-connector
    spec:
      containers:
        - name: connector
          image: sorinboiaf5/f5-ai-connector:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 22080
              name: http
            - containerPort: 22443
              name: https
            - containerPort: 22100
              name: management
            - containerPort: 10000
              name: forward-proxy
          env:
            # Enable per-host leaf cert issuance signed by the injected CA
            - name: DYNAMIC_CERTS_ENABLED
              value: "true"
            - name: MITM_CA_CERT
              value: /app/certs/mitm/ca.crt
            - name: MITM_CA_KEY
              value: /app/certs/mitm/ca.key
            - name: MITM_CERT_VALIDITY_DAYS
              value: "365"
            # Persist config store outside the container FS
            - name: CONFIG_STORE_PATH
              value: /app/node/var/guardrails_config.json
          volumeMounts:
            - name: guardrails-config
              mountPath: /app/node/var
            - name: mitm-ca
              mountPath: /app/certs/mitm
              readOnly: true
      volumes:
        - name: guardrails-config
          hostPath:
            path: /var/lib/f5-ai-guardrails/config
            type: DirectoryOrCreate
        - name: mitm-ca
          secret:
            secretName: connector-mitm-ca
            items:
              - key: ca.crt
                path: ca.crt
              - key: ca.key
                path: ca.key
---
apiVersion: v1
kind: Service
metadata:
  name: f5-ai-guardrails-connector
  labels:
    app: f5-ai-guardrails-connector
spec:
  type: NodePort
  selector:
    app: f5-ai-guardrails-connector
  ports:
    - name: http
      port: 22080
      targetPort: 22080
      nodePort: 32080
    - name: https
      port: 22443
      targetPort: 22443
      nodePort: 32443
    - name: management
      port: 22100
      targetPort: 22100
      nodePort: 32100
    - name: forward-proxy
      port: 10000
      targetPort: 10000
      nodePort: 31000
---
apiVersion: v1
kind: Secret
metadata:
  name: connector-mitm-ca
  labels:
    app: f5-ai-guardrails-connector
type: Opaque
stringData:
  ca.crt: |
    -----BEGIN CERTIFICATE-----
    MIIFKzCCAxOgAwIBAgIUILAqLH/ECP0/3st3TL4utyVxHHYwDQYJKoZIhvcNAQEL
    BQAwJTEjMCEGA1UEAwwaRjUgQ29ubmVjdG9yIExvY2FsIE1JVE0gQ0EwHhcNMjUx
    MjA0MTMxMDExWhcNMzUxMjAyMTMxMDExWjAlMSMwIQYDVQQDDBpGNSBDb25uZWN0
    b3IgTG9jYWwgTUlUTSBDQTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIB
    AJTUkERhIbEgdOUPkSjv4Fu06TiiBBtGX4RlyVQarnsi9YY6ZqUYxwrqskiQRQtm
    uDbKGGQvgMRnk0FTJcF3fy26s6M3oqjt49oLBeq1cx3Xo1hRP0kFjny8Awai+MSf
    Hw1Nf/AuFohjrw2wgYqbgzEXUVWUIDE3EoWBpjkQ5X6PCyokF24J2X1cAqgavx8G
    vUE3i/X8O5BTr7i0IhqzOlH1ebbuhZWC+4JqMoGdLKYzR1BfjnHOkpQVTjFAN57x
    6FYyjDgtiws4cgZRPW6QlhlYOvdtmfmx0Kmsv+5JRWiwqUjpfXMS6Q6aN5T23d5U
    M5yzcf5pxXJp6BlPYVDxBwN2Sa3xXyd8ODx4sR4LSJRZXBlYtcZ0FWRY2KVTiZlC
    lcPuAibEYFp01KN02ZHnP1RbmUOFihdbfU4UKqDEQFfqndOdNJtsDTt2EOrAOW7+
    sgJyT+1pd5+M10PdLM4FXeeKtGOxewerLJKyrpVA4imM6199+RYf548TutPwRrtJ
    yWsliJ7n0ASnUWIjJs7eYh47OpUvQNYP9aBHNGHhtBMymwBbg8PAK8mOFzNqxLti
    PDoQ4zhNb9qn1Xmh8Vy0vq7s02Wf+Cv8N+ZJWyjGhGIMN6/yRyt44Rgb8fMWxD5g
    lzBRe8EZVPoYt/y8cMTb+pE0Qf5bqXtlY0zslKuDlqXrAgMBAAGjUzBRMB0GA1Ud
    DgQWBBQrPLtkdi9eiOwZuW/kGcUaUeqW+DAfBgNVHSMEGDAWgBQrPLtkdi9eiOwZ
    uW/kGcUaUeqW+DAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4ICAQAC
    iM2MVyaaXaUlkZdIi4DN6qn+lHniY8iRXLWV7mlSOerPUcXGipMO/9s5LOKMIBLI
    h5lq4rvZOT2S0wNv4ApXBGxWxqOIWLsykxsYq5Q6h2wbsCdsUQkXJwlMi+ldVyM8
    7BWj2ZvEXbVS9rUzEwkD2c1L1VzokOjbpUIyMBSmRmBvgI1J5ag0VIKbazhuOHQ+
    znPdgb/uJn3OO2J4TXTGVxhyJTddihFQbFVekfm8n5f3Scr6ElTopL5HZr776SjJ
    253iqKbI4T3Txdo7iODtcgS27NpCXwV/sENe3vELkZLVK1jehcvA/AWC4ppikyax
    SHmFnrnqQaYEjmMYHqS/x+W7KAZvJ5Y9kHk46AOoBBplTWeCKN2cm9c3hQ4n3gKq
    drarhKVBuhNm4l3AiwqCEEYg4sVk6cQW4KwLgAgM3pVrtpxeaAKZAceZLzJNJId6
    Z+Eyh9vHiufrUvVdI9CavnLrn/fCat6bf4rbQIdJXqpxmRLkOJsyrTv5pqTfqJ9r
    KHplD+vftb75NtfbzvgVHnrZBIwoDcyU1pVTqtF/NXFfH6AJoSVEENBP4Weco41K
    qZV3mnkAOs0X/9xTfwcc4NV852zcfrg+DbiUd1Q8BwTJhh6PEgTKV+B5yn8lfFSk
    mXjk7eJp8vq52zdq5xLmiuoniCLpVB8htwe+Y0LgbA==
    -----END CERTIFICATE-----
  ca.key: |
    -----BEGIN PRIVATE KEY-----
    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
    QtbzOc8nEAEtTobDJMLqlv0SclAV
    -----END PRIVATE KEY-----
