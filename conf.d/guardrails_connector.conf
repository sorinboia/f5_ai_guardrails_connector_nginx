# /etc/nginx/conf/sideband-proxy.conf

map $http_x_sideband_inspect $sideband_inspect {
  default  "";
  "~^(request|response|both|off)$" $http_x_sideband_inspect;
}

# Optional: log level via header too
map $http_x_sideband_log $sideband_log {
  default  "";
  "~^(debug|info|warn|err)$" $http_x_sideband_log;
}

map $http_x_sideband_forward $sideband_request_forward {
  default  "";
  "~^(sequential|parallel)$" $http_x_sideband_forward;
}

# Test host sideband override: route Guardrails calls to local stub when Host=tests.local
map $host $sideband_url {
  default "";
  tests.local http://127.0.0.1:18081/backend/v1/scans;
}

js_engine qjs;  
js_path /etc/nginx/njs/;

js_import sideband from sideband.js;
js_import config_api from config_api.js;
js_import collector_api from collector_api.js;
js_import api_keys_api from api_keys_api.js;
js_import patterns_api from patterns_api.js;
js_import utils from utils.js;

js_set $backend_origin_effective utils.backendOriginVar;

# DNS for ngx.fetch (domain in the sideband URL)
resolver 1.1.1.1 8.8.8.8 valid=300s ipv6=off;

# CA bundle so ngx.fetch() can verify HTTPS servers
# Debian/Ubuntu: /etc/ssl/certs/ca-certificates.crt
# RHEL/CentOS:  /etc/pki/tls/certs/ca-bundle.crt
js_fetch_trusted_certificate /etc/ssl/certs/ca-certificates.crt;

server {
    listen 11434;
    proxy_ssl_server_name on;
    proxy_ssl_name $proxy_host;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
    #proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    #proxy_ssl_verify on;
    # Keep JSON bodies in memory so njs can read and forward them.
    client_body_buffer_size 1m;
    # Allow larger streaming responses from the subrequest (/backend).
    # LLM replies can exceed 256k; raise to avoid "too big subrequest response" errors.
    subrequest_output_buffer_size 8m;

    location = /config/ui {
        default_type text/html;
        add_header Cache-Control 'no-store';
        alias /etc/nginx/html/scanner-config.html;
    }

    location /config/ui/ {
        return 302 /config/ui;
    }

    location = /config/ui/keys {
        default_type text/html;
        add_header Cache-Control 'no-store';
        alias /etc/nginx/html/scanner-config.html;
    }

    location /config/ui/keys/ {
        return 302 /config/ui/keys;
    }

    location = /config/ui/patterns {
        default_type text/html;
        add_header Cache-Control 'no-store';
        alias /etc/nginx/html/scanner-config.html;
    }

    location ^~ /config/css/ {
        alias /etc/nginx/html/css/;
        default_type text/css;
        add_header Cache-Control 'no-store';
    }

    location ^~ /config/js/ {
        alias /etc/nginx/html/js/;
        default_type application/javascript;
        add_header Cache-Control 'no-store';
    }

    location /config/ui/patterns/ {
        return 302 /config/ui/patterns;
    }

    location = /collector/ui {
        return 302 /config/ui;
    }

    location = /config/api {
        default_type application/json;
        js_content config_api.handle;
    }

    location = /config/api/keys {
        default_type application/json;
        js_content api_keys_api.handle;
    }

    location = /config/api/patterns {
        default_type application/json;
        js_content patterns_api.handle;
    }

    location = /collector/api {
        default_type application/json;
        js_content collector_api.handle;
    }

    error_log /var/log/nginx/sideband.error.log info;
    access_log /var/log/nginx/sideband.access.log combined;

    # njs handler: read/log, sideband fetch, then forward
    location / {
        js_content sideband.handle;
    }

    location /api/tags {
	set $backend_origin $backend_origin_effective;
	proxy_pass $backend_origin;

        # Keep this minimal; we don't touch headers/body/method.
        proxy_http_version 1.1;
        proxy_set_header Connection "";  # enable upstream keepalive
        proxy_set_header Host $proxy_host;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_max_temp_file_size 0;

    }

    location ~ ^/backend(/.*)$ {
        internal;
	set $backend_origin $backend_origin_effective;
	proxy_pass $backend_origin$1$is_args$args;
	proxy_http_version 1.1;
        proxy_set_header Connection "";  # enable upstream keepalive
        proxy_set_header Host $proxy_host;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_max_temp_file_size 0;
    }

    # Receives the internal redirect; proxies the *original* request unchanged
    location @backend {
        set $backend_origin $backend_origin_effective;
        proxy_pass $backend_origin;

        # Keep this minimal; we don't touch headers/body/method.
        proxy_http_version 1.1;
        proxy_set_header Connection "";  # enable upstream keepalive
        proxy_set_header Host $proxy_host;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_max_temp_file_size 0;
    }
}

server {
    listen 443 ssl;
    proxy_ssl_server_name on;
    proxy_ssl_name $proxy_host;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
    client_body_buffer_size 1m;
    subrequest_output_buffer_size 8m;

    ssl_certificate /etc/nginx/certs/sideband-local.crt;
    ssl_certificate_key /etc/nginx/certs/sideband-local.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location = /config/ui {
        default_type text/html;
        add_header Cache-Control 'no-store';
        alias /etc/nginx/html/scanner-config.html;
    }

    location /config/ui/ {
        return 302 /config/ui;
    }

    location = /config/ui/keys {
        default_type text/html;
        add_header Cache-Control 'no-store';
        alias /etc/nginx/html/scanner-config.html;
    }

    location /config/ui/keys/ {
        return 302 /config/ui/keys;
    }

    location = /config/ui/patterns {
        default_type text/html;
        add_header Cache-Control 'no-store';
        alias /etc/nginx/html/scanner-config.html;
    }

    location ^~ /config/css/ {
        alias /etc/nginx/html/css/;
        default_type text/css;
        add_header Cache-Control 'no-store';
    }

    location ^~ /config/js/ {
        alias /etc/nginx/html/js/;
        default_type application/javascript;
        add_header Cache-Control 'no-store';
    }

    location /config/ui/patterns/ {
        return 302 /config/ui/patterns;
    }

    location = /collector/ui {
        return 302 /config/ui;
    }

    location = /config/api {
        default_type application/json;
        js_content config_api.handle;
    }

    location = /config/api/keys {
        default_type application/json;
        js_content api_keys_api.handle;
    }

    location = /config/api/patterns {
        default_type application/json;
        js_content patterns_api.handle;
    }

    location = /collector/api {
        default_type application/json;
        js_content collector_api.handle;
    }

    error_log /var/log/nginx/sideband-https.error.log info;
    access_log /var/log/nginx/sideband-https.access.log combined;

    location / {
        js_content sideband.handle;
    }

    location /api/tags {
        set $backend_origin $backend_origin_effective;
        proxy_pass $backend_origin;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $proxy_host;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_max_temp_file_size 0;
    }

    location ~ ^/backend(/.*)$ {
        internal;
        set $backend_origin $backend_origin_effective;
        proxy_pass $backend_origin$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $proxy_host;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_max_temp_file_size 0;
    }

    location @backend {
        set $backend_origin $backend_origin_effective;
        proxy_pass $backend_origin;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $proxy_host;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_max_temp_file_size 0;
    }
}
